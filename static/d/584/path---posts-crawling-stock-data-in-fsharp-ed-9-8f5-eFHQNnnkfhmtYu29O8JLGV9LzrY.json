{"data":{"markdownRemark":{"id":"69260f54-6707-55a9-b0da-ec3953ae08c3","html":"<p>作为一根韭菜，很重要的当然是盯盘，这时候你是要在上班的时候掏出手机看还是打开网页看？</p>\n<p>作为一根合格的韭菜，答案当然是用命令行了！够低调，同时内容又高度定制化。</p>\n<p>而作为一根在 .NET 的生态里讨饭吃的韭菜，我首选的工具是 F#。</p>\n<h3 id=\"为什么选择-fsharp\"><a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9-fsharp\" aria-label=\"为什么选择 fsharp permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>为什么选择 FSharp</h3>\n<ul>\n<li>\n<p>F# 是 Functional base 的编程语言，相较于C#，语法更灵活也更简洁。同时 F# 并不如 Haskell 那般 strict，可以使用多范式去构建程序，所以也可以很方便的使用 .NET 上其他的绝大多数 DLL 库，无缝和 C# 进行交互。换言之，.NET 拥有的能力，F# 都可以有。</p>\n</li>\n<li>\n<p>相较于 C#，F# 拥有更强大的类型系统。</p>\n</li>\n<li>\n<p>虽然相对于其他 OOP 风格的语言来说，C# 已经有了 LINQ 这样的大杀器，但是 F# 借助 computation expression 的扩展，不但支持类 LINQ 的语法 <a href=\"https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/query-expressions\">Query Expression</a>，而且更强大，也更易于扩展。</p>\n</li>\n<li>\n<p>同样得益于 computation expression，F# 有更好的异步支持 <a href=\"https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/asynchronous-workflows\">Async Workflow</a></p>\n</li>\n</ul>\n<p>简单讲就是 C# 有的 F# 都有，同时 F# 可以更简洁。</p>\n<h3 id=\"初始化项目\"><a href=\"#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE\" aria-label=\"初始化项目 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>初始化项目</h3>\n<p>进入正题，首先，需要去创建一个新的 Project。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">dotnet new console <span class=\"token operator\">-</span>lang F<span class=\"token comment\"># -o TStock</span></code></pre></div>\n<p>这里的 <code class=\"language-text\">-lang</code> 指定使用的编程语言是 F#, <code class=\"language-text\">-o</code> 指定了项目目录名称。</p>\n<p>然后在生成的 <code class=\"language-text\">Program.fs</code> 中可以看到如下代码</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token comment\">// Learn more about F# at http://fsharp.org</span>\n\n<span class=\"token keyword\">open</span> System\n\n<span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">EntryPoint</span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">let</span> main argv <span class=\"token operator\">=</span>\n    printfn <span class=\"token string\">\"Hello World from F#!\"</span>\n    <span class=\"token number\">0</span> <span class=\"token comment\">// return an integer exit code</span></code></pre></div>\n<p>使用 <code class=\"language-text\">dotnet run</code> 执行可以得到输出 <code class=\"language-text\">Hello World from F#!</code>。</p>\n<h3 id=\"使用-paket-管理依赖\"><a href=\"#%E4%BD%BF%E7%94%A8-paket-%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96\" aria-label=\"使用 paket 管理依赖 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使用 paket 管理依赖</h3>\n<p><a href=\"https://fsprojects.github.io/Paket/index.html\">paket</a> 是 F# 社区实现的一款包管理工具，相较于 <code class=\"language-text\">nuget</code> 来说更灵活一些，可以同时用来管理 <code class=\"language-text\">nuget</code> 和 <code class=\"language-text\">github</code> 上的依赖。</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">choco install paket</code></pre></div>\n<p>如果没有安装过 <code class=\"language-text\">paket</code>，可以用 <a href=\"https://chocolatey.org/\">chocolatey</a> 方便的安装 <code class=\"language-text\">paket</code>, 安装好之后，需要在项目中初始化 <code class=\"language-text\">paket</code></p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">paket init</code></pre></div>\n<p>这是时候项目中多出了 <code class=\"language-text\">.paket</code>, <code class=\"language-text\">.paket-files</code>, <code class=\"language-text\">paket.dependencies</code>。</p>\n<p>在 <code class=\"language-text\">paket.dependencies</code> 中写入依赖如下</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">source https://www.nuget.org/api/v2\n\nnuget FSharp.Core\nnuget FSharp.Data\nnuget FSharp.Json</code></pre></div>\n<p>使用 <code class=\"language-text\">.\\paket\\paket.exe install</code> 安装依赖。</p>\n<p>这时候声明的依赖都安装到了 <code class=\"language-text\">packages</code> 目录下，那么怎么使用呢?</p>\n<p>在和 <code class=\"language-text\">*.fsproj</code>同目录的地方创建一个 <code class=\"language-text\">paket.references</code> 文件，里面写入这个项目的依赖</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FSharp.Core\nFSharp.Data\nFSharp.Json</code></pre></div>\n<p>这主要是因为考虑到通常一个 solution 下面需要很多个 project 的情况。</p>\n<p>再跑一次 <code class=\"language-text\">.\\paket\\paket.exe install</code>, <code class=\"language-text\">.paket</code> 目录下多了一个 <code class=\"language-text\">Paket.Restore.targets</code> 文件，fsproj 文件中也多出了一行</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>.paket\\Paket.Restore.targets<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>通过这个文件，就可以在项目中引用到安装的依赖了。</p>\n<h3 id=\"编写代码\"><a href=\"#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81\" aria-label=\"编写代码 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>编写代码</h3>\n<p>先保留 main 函数里面的部分不动，开始代码逻辑部分的处理。</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Code</span> <span class=\"token operator\">=</span> Code <span class=\"token keyword\">of</span> <span class=\"token class-name\">string</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">StockCode</span> <span class=\"token operator\">=</span>\n    <span class=\"token operator\">|</span> SH <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n    <span class=\"token operator\">|</span> SZ <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n    <span class=\"token operator\">|</span> HK <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n    <span class=\"token operator\">|</span> NSDQ <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Stock</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n    Code<span class=\"token punctuation\">:</span> <span class=\"token class-name\">StockCode</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Code</code> 是股票编码，但是 A 股、港股、美股等都有不同情况要处理，如何进行区分？所以我引入了 <code class=\"language-text\">StockCode</code> 的 union type，这样就有办法描述更多的股票了。</p>\n<p>如果用 C# 会是什么情况？</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BaseCode</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">string</span> _code <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">string</span> Code\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> _code<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">Sz</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span> code<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _code <span class=\"token operator\">=</span> code\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">string</span> <span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Code<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SHCode</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BaseCode</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">SHCode</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">:</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">base</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token keyword\">string</span> <span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"sh\"</span> <span class=\"token operator\">+</span> Code<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SZCode</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BaseCode</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/// blabla</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HKCode</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">BaseCode</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/// blabla</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/// blabla</span></code></pre></div>\n<p>接下来就是数据部分了，这部分不是我的重点，很多网站都有股票实时数据，比如新浪股票，都是可以的选择。值得注意的是，这些网站都加了反爬虫的技术，另一方面，股票数据要实时刷新，为了逻辑上统一，股票数据一般都是由异步接口提供，jsonp 或者 json，具体的接口不同的网站不同，需要自己去分析。</p>\n<p>找到接口之后，就可以愉快的拿数据来玩耍了。</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">StockData</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Price<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n    Open<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n    High<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n    Low<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n    UpDown<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n    UpDownRate<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n    ExchangeRatio<span class=\"token punctuation\">:</span> <span class=\"token class-name\">float</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">StockResult</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Stock<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Stock</span>\n    Data<span class=\"token punctuation\">:</span> <span class=\"token class-name\">StockData</span> option\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里 <code class=\"language-text\">StockData</code> 定义了拿到的数据格式，<code class=\"language-text\">StockResult</code> 定义了完整的返回结果，将数据信息和股票信息关联起来，方便后面的处理。</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> getStockData <span class=\"token punctuation\">(</span>stock<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Stock</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token computation-expression keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> code <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">.</span>Code\n        <span class=\"token keyword\">let</span> baseURL <span class=\"token operator\">=</span> sprintf <span class=\"token string\">\"http://%s.%s/%s/quotelist\"</span> <span class=\"token punctuation\">(</span>getHostPrefix code<span class=\"token punctuation\">)</span> baseHost <span class=\"token punctuation\">(</span>getRegion code<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> sprintf <span class=\"token string\">\"%s?code=%s&amp;column=%s&amp;callback=%s\"</span> baseURL <span class=\"token punctuation\">(</span>getCodeString code<span class=\"token punctuation\">)</span> column callback\n        <span class=\"token keyword\">let!</span> resp <span class=\"token operator\">=</span> Http<span class=\"token punctuation\">.</span>AsyncRequest url\n        <span class=\"token keyword\">if</span> resp<span class=\"token punctuation\">.</span>StatusCode <span class=\"token operator\">></span> <span class=\"token number\">300</span> <span class=\"token keyword\">then</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> Stock <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">;</span> Data <span class=\"token operator\">=</span> None <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span>\n            <span class=\"token keyword\">let</span> stockData <span class=\"token operator\">=</span> resp<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> parseData code\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> Stock <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">;</span> Data <span class=\"token operator\">=</span> stockData <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里的逻辑很简单，就是拿到传入一只股票的基本信息，根据股票的 code 信息拼出完整 url，再通过一个异步请求去获取数据。这里的异步请求本身可能因为各种原因失败，所以这里的 Data 是一个 <code class=\"language-text\">Option</code> 类型的结果。</p>\n<p>我这里取的是一个 jsonp 的请求，不能直接 deserialize 成一个对象，所以用了一个额外的 parseData 方法来处理数据</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> parseData code <span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">try</span>\n        <span class=\"token keyword\">let</span> valuePart <span class=\"token operator\">=</span> text<span class=\"token punctuation\">.</span><span class=\"token function\">Split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">let</span> unit <span class=\"token operator\">=</span> <span class=\"token keyword\">match</span> code <span class=\"token keyword\">with</span>\n                    <span class=\"token operator\">|</span> HK _ <span class=\"token operator\">-></span> <span class=\"token number\">1000.0</span>\n                    <span class=\"token operator\">|</span> _ <span class=\"token operator\">-></span> <span class=\"token number\">100.0</span>\n        valuePart<span class=\"token punctuation\">.</span><span class=\"token function\">Substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> valuePart<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">-</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">|></span> Seq<span class=\"token punctuation\">.</span>map <span class=\"token punctuation\">(</span>float <span class=\"token operator\">>></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> x <span class=\"token operator\">-></span> x <span class=\"token operator\">/</span> unit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">|></span> Seq<span class=\"token punctuation\">.</span>toArray\n        <span class=\"token operator\">|></span> <span class=\"token keyword\">fun</span> s <span class=\"token operator\">-></span>\n            <span class=\"token computation-expression keyword\">Some</span> <span class=\"token punctuation\">{</span>\n                Price <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n                Open <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n                High <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n                Low <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n                UpDown <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span>\n                UpDownRate <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n                ExchangeRatio <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">with</span>\n        <span class=\"token operator\">|</span> _ <span class=\"token operator\">-></span> None</code></pre></div>\n<p>这里 parse 本身是一个极容易发生错误的过程，返回结果不对，或者返回结果不规范都有可能导致失败，由于我不关心错误原因，所以只要错误返回 None 就可以了，try 里面只关心正常的逻辑，这样可以让代码更好读一点。</p>\n<p>这里面有两个奇怪的符号 <code class=\"language-text\">|&gt;</code>、 <code class=\"language-text\">&gt;&gt;</code>，它们本质上都是函数，<code class=\"language-text\">|&gt;</code> 的定义是 <code class=\"language-text\">( |&gt; ): &#39;T1 -&gt; (&#39;T1 -&gt; &#39;U) -&gt; &#39;U</code>，即将左侧的参数 apply 到右侧的函数中，返回其结果，类似于一个管道，将数据流处理通过一个个函数串联起来，基本上是 fsharp 中最常见的符号了。<code class=\"language-text\">&gt;&gt;</code> 的定义是 <code class=\"language-text\">( &gt;&gt; ) : (&#39;T1 -&gt; &#39;T2) -&gt; (&#39;T2 -&gt; &#39;T3) -&gt; &#39;T1 -&gt; &#39;T3</code>，即 compose 函数，将两个函数组装成一个函数。</p>\n<p>还有一个比较 tricky 的事实是，fsharp 去处理这样的中缀符号的结合性的时候，是通过符号的形状来决定的，而不是像 Haskell 那样去显式的声明其结合性和优先级。</p>\n<p>有了这些方法之后，主要功能就基本上完成了。最后来更改 <code class=\"language-text\">main</code> 函数。</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">EntryPoint</span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">let</span> main argv <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> stocks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            Name <span class=\"token operator\">=</span> <span class=\"token string\">\"MSFT\"</span><span class=\"token punctuation\">;</span>\n            Code <span class=\"token operator\">=</span> NSDQ <span class=\"token punctuation\">(</span>Code <span class=\"token string\">\"MSFT\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n\n    stocks\n    <span class=\"token operator\">|></span> Seq<span class=\"token punctuation\">.</span>map getStockData\n    <span class=\"token operator\">|></span> Async<span class=\"token punctuation\">.</span>Parallel\n    <span class=\"token operator\">|></span> Async<span class=\"token punctuation\">.</span>RunSynchronously\n    <span class=\"token operator\">|></span> Seq<span class=\"token punctuation\">.</span>iter\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> result <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">match</span> result <span class=\"token keyword\">with</span>\n            <span class=\"token operator\">|</span> result <span class=\"token keyword\">when</span> result<span class=\"token punctuation\">.</span>Data <span class=\"token operator\">=</span> None <span class=\"token operator\">-></span> printfn <span class=\"token string\">\"|%-20s|%10s|%10s|%10s|%10s|%10s|%10s|\"</span> result<span class=\"token punctuation\">.</span>Stock<span class=\"token punctuation\">.</span>Name <span class=\"token string\">\"_\"</span> <span class=\"token string\">\"_\"</span> <span class=\"token string\">\"_\"</span> <span class=\"token string\">\"_\"</span> <span class=\"token string\">\"_\"</span> <span class=\"token string\">\"_\"</span>\n            <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> StockResult<span class=\"token punctuation\">.</span>Stock <span class=\"token operator\">=</span> stock<span class=\"token punctuation\">;</span> StockResult<span class=\"token punctuation\">.</span>Data <span class=\"token operator\">=</span> Some data <span class=\"token punctuation\">}</span> <span class=\"token operator\">-></span>\n                printfn <span class=\"token string\">\"|%-20s|%10.2f|%10.2f|%10.2f|%10.2f|%10.2f|%10.2f%%|\"</span> stock<span class=\"token punctuation\">.</span>Name data<span class=\"token punctuation\">.</span>Price data<span class=\"token punctuation\">.</span>Open data<span class=\"token punctuation\">.</span>Low data<span class=\"token punctuation\">.</span>High data<span class=\"token punctuation\">.</span>UpDown data<span class=\"token punctuation\">.</span>UpDownRate\n            <span class=\"token operator\">|</span> _ <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token number\">0</span></code></pre></div>\n<p>这里有使用 <code class=\"language-text\">printfn</code> 将最后拿到的结果打印成表格呈现到终端。</p>\n<h3 id=\"扩展应用\"><a href=\"#%E6%89%A9%E5%B1%95%E5%BA%94%E7%94%A8\" aria-label=\"扩展应用 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>扩展应用</h3>\n<p>为了让代码更灵活，这里把 <code class=\"language-text\">stocks</code> 放到一个外部 json 文件中，通过命令行参数进行捕获。这里我用到的是 <code class=\"language-text\">FSharp.Json</code> 这个库。</p>\n<p>首先需要给最初定义的 <code class=\"language-text\">StockCode</code> 和 <code class=\"language-text\">Stock</code> 类型加一些辅助的 attribute。这里涉及到一个 union type 的映射问题，当然，这里的代码是非常直白的。</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">open</span> FSharp<span class=\"token punctuation\">.</span>Json\n\n<span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">JsonUnion</span><span class=\"token annotation-content\"><span class=\"token punctuation\">(</span>Mode<span class=\"token operator\">=</span>UnionMode<span class=\"token punctuation\">.</span>CaseKeyAsFieldValue<span class=\"token punctuation\">,</span> CaseKeyField<span class=\"token operator\">=</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">,</span> CaseValueField<span class=\"token operator\">=</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">StockCode</span> <span class=\"token operator\">=</span>\n    <span class=\"token operator\">|</span> SH <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n    <span class=\"token operator\">|</span> SZ <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n    <span class=\"token operator\">|</span> HK <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n    <span class=\"token operator\">|</span> NSDQ <span class=\"token keyword\">of</span> <span class=\"token class-name\">Code</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Stock</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">JsonField</span><span class=\"token annotation-content\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">>]</span></span>\n    Name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n    <span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">JsonField</span><span class=\"token annotation-content\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">>]</span></span>\n    Code<span class=\"token punctuation\">:</span> <span class=\"token class-name\">StockCode</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后是更改我们的 main 函数。通过 <code class=\"language-text\">argv</code> 传入 filename，再通过 <code class=\"language-text\">File</code> 把内容读取到程序中，最后通过 <code class=\"language-text\">FSharp.Json</code> deserialize 成我们需要的结构，其他统统保持不变。</p>\n<div class=\"gatsby-highlight\" data-language=\"fsharp\"><pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">EntryPoint</span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">let</span> main argv <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> filename <span class=\"token operator\">=</span> argv<span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">let</span> content <span class=\"token operator\">=</span> File<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAllText</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> stocks <span class=\"token operator\">=</span> Json<span class=\"token punctuation\">.</span>deserialize<span class=\"token operator\">&lt;</span>Stock<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// ...</span></code></pre></div>\n<p>下面是 <code class=\"language-text\">stocks.json</code> 文件的一个示例。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MSFT\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"code\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NSDQ\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"code\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MSFT\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>以上，就是整个应用的主要实现了，当然为了节省篇幅，中间省去了一些细枝末节。</p>\n<p>完整的代码可以去访问我的 <a href=\"https://github.com/nodew/TStock\">Github</a> 查看。</p>","fields":{"slug":"/posts/crawling-stock-data-in-fsharp/","tagSlugs":["/tag/fsharp-crawler/"]},"frontmatter":{"date":"2019-07-13","description":"作为一根韭菜，很重要的当然是盯盘，这时候你是要在上班的时候掏出手机看还是打开网页看？作为一根合格的韭菜，答案当然是用命令行了！够低调，同时内容又高度定制化。而作为一根在 .NET 的生态里讨饭吃的韭菜，我首选的工具是 F#。 ","tags":["fsharp, crawler"],"title":"F# 初接触 - 获取实时股票数据"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/crawling-stock-data-in-fsharp/"}}